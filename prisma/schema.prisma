// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TaxType {
  percentage
  fixed
}

enum DiscountType {
  percentage
  fixed
}

enum PromotionType {
  automatic
  coupon
}

enum ProductStatus {
  active
  inactive
  draft
}

enum StatusDelete {
  active
  inactive
  deleted
}

enum StatusStore {
  pending
  active
  inactive
  banned
  deleted
}

enum OrderStatus {
  pending
  processing
  shipped
  completed
  cancelled
  refunded
}

enum BlogPostStatus {
  draft
  published
  archived
}

enum UserStatus {
  active
  pending_review
  disabled
}

enum RolesEnum {
  admin
  seller
  buyer
  support
}

enum LegalDocumentType {
  terms
  privacy
  cookies
  returns
  shipping
  custom
}

enum UploadAssetType {
  image
  video
  audio
  document
  other
}

// enum StoreAddress {
//   country
//   city
//   state
//   postalCode
//   street
//   note
// }

model User {
  id    String @id @default(uuid())
  email String @unique

  firstName   String?
  lastName    String?
  displayName String?

  username      String?
  phone         String?
  status        UserStatus @default(active)
  profileImage  String?
  role          RolesEnum  @default(buyer)
  isOnline      Boolean    @default(false)
  emailVerified Boolean
  lastLogin     DateTime?
  lastSeenAt    DateTime?
  password      String
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Soft delete / auditoria
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?

  sessions            Session[]
  order               Order[]
  store               Store?
  reviews             Review[]
  loyaltyAccount      LoyaltyAccount?
  loyaltyTransactions LoyaltyTransaction[]
  loyaltyRedemptions  LoyaltyRedemption[]
  blogPosts           BlogPost[]
  addresses           UserAddress[]
  favorites           Favorite[]
  uploadAssets        UploadAsset[]
}

model Session {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  refreshToken String  @unique // token opaco; idealmente guarda HASH
  userAgent    String?
  ip           String?
  deviceId     String? // opcional: identifica dispositivo

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  expiresAt DateTime

  revoked   Boolean   @default(false)
  revokedAt DateTime?

  @@index([userId])
  @@index([userId, revoked, expiresAt])
  @@index([expiresAt])
}

model Store {
  id            String      @id @default(uuid())
  name          String
  tagline       String?
  description   String
  email         String?
  phone         String?
  address       Json?
  website       String?
  logo          String?
  banner        String?
  facebook      String?
  instagram     String?
  twitter       String?
  youtube       String?
  status        StatusStore
  isFeatured    Boolean     @default(false)
  featuredUntil DateTime?

  // SEO
  keywords  String?
  metaTitle String?
  metaDesc  String?

  // Horarios
  businessHours Json?

  // Relaciones
  ownerId    String      @unique
  owner      User        @relation(fields: [ownerId], references: [id])
  taxes      Tax[]
  discounts  Discount[]
  promotions Promotion[]
  products   Product[]
  orders     Order[]

  // Soft delete / auditoria
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  reviews         Review[]
  shippingMethods ShippingMethod[]
}

enum ShippingStatus {
  active
  inactive
}

model ShippingMethod {
  id          String         @id @default(uuid())
  name        String
  description String?
  cost        Float
  status      ShippingStatus @default(active)

  storeId String
  store   Store  @relation(fields: [storeId], references: [id])
  orders  Order[]

  // Soft delete / auditoria
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Tax {
  id          String       @id @default(uuid())
  name        String
  type        TaxType
  rate        Float
  description String?
  status      StatusDelete
  storeId     String
  store       Store        @relation(fields: [storeId], references: [id])
  productTax  ProductTax[]
  isDeleted   Boolean      @default(false)
  deletedAt   DateTime?
  deletedBy   String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  // Order       Order[] // This relation is removed as Discount is product-level
}

model Discount {
  id          String       @id @default(uuid())
  name        String
  type        DiscountType
  value       Float
  description String?
  status      StatusDelete
  storeId     String
  store       Store        @relation(fields: [storeId], references: [id])
  products    Product[]
  isDeleted   Boolean      @default(false)
  deletedAt   DateTime?
  deletedBy   String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  Order       Order[]
}

model Promotion {
  id          String        @id @default(uuid())
  name        String
  description String?
  type        PromotionType
  value       Float?
  code        String?
  startsAt    DateTime?
  endsAt      DateTime?
  status      StatusDelete
  storeId     String
  store       Store         @relation(fields: [storeId], references: [id])
  isDeleted   Boolean       @default(false)
  deletedAt   DateTime?
  deletedBy   String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  order       Order[]
}

model ProductTax {
  productId String
  taxId     String
  product   Product @relation(fields: [productId], references: [id])
  tax       Tax     @relation(fields: [taxId], references: [id])

  @@id([productId, taxId])
}

model Product {
  id              String        @id @default(uuid())
  name            String
  description     String
  sku             String?       @unique
  price           Float         @default(0)
  priceFinal      Float         @default(0)
  taxes           ProductTax[]
  stock           Int
  images          String[]
  status          ProductStatus @default(active)
  metaTitle       String?
  metaDescription String?
  isFeatured      Boolean       @default(false)

  // Relación con Descuentos
  discountId String?
  discount   Discount? @relation(fields: [discountId], references: [id])

  //relacion con tienda
  storeId String
  store   Store  @relation(fields: [storeId], references: [id])

  //relacion con otros productos (productos relacionados)
  relatedProducts Product[] @relation("RelatedProducts")
  relatedBy       Product[] @relation("RelatedProducts")

  //relacion con categorias
  categories Category[] @relation("ProductCategories")

  orderItem OrderItem[]
  review    Review[]
  favorites Favorite[]
  favoritesCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Category {
  id         String     @id @default(uuid())
  name       String
  slug       String     @unique
  description String?
  parentId   String?
  parent     Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children   Category[] @relation("CategoryHierarchy")
  order      Int        @default(0)
  isFeatured Boolean    @default(false)
  products   Product[]  @relation("ProductCategories")
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@index([parentId, order])
}

model Order {
  id      String      @id @default(uuid())
  userId  String
  storeId String
  status  OrderStatus @default(pending)

  user  User        @relation(fields: [userId], references: [id])
  store Store       @relation(fields: [storeId], references: [id])
  items OrderItem[]

  // Desglose de precio
  subtotal            Float
  totalDiscountAmount Float @default(0)
  taxAmount           Float @default(0)
  shippingAmount      Float @default(0)
  total               Float

  // Información de envío
  shippingAddress  Json?
  shippingMethodId String?
  shippingMethod   ShippingMethod? @relation(fields: [shippingMethodId], references: [id])
  trackingNumber   String?

  promotionId       String?
  promotion         Promotion? @relation(fields: [promotionId], references: [id])
  promotionCodeUsed String?
  priceAdjustments  Json?

  // Soft delete / auditoria
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  Discount   Discount? @relation(fields: [discountId], references: [id])
  discountId String?
}

model OrderItem {
  id             String   @id @default(uuid())
  orderId        String
  productId      String
  quantity       Int
  unitPrice      Float    @default(0)
  unitPriceFinal Float    @default(0)
  lineSubtotal   Float    @default(0)
  lineDiscount   Float    @default(0)
  order          Order    @relation(fields: [orderId], references: [id])
  product        Product  @relation(fields: [productId], references: [id])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String
  productId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
}

model UserAddress {
  id        String   @id @default(uuid())
  userId    String
  label     String?
  address   Json
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Review {
  id        String  @id @default(uuid())
  rating    Int
  comment   String?
  userId    String
  productId String
  storeId   String

  user    User    @relation(fields: [userId], references: [id])
  product Product @relation(fields: [productId], references: [id])
  store   Store   @relation(fields: [storeId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BlogPost {
  id          String         @id @default(uuid())
  title       String
  slug        String         @unique
  excerpt     String?
  content     String
  coverImage  String?
  status      BlogPostStatus @default(draft)
  publishedAt DateTime?
  tags        String[]       @default([])

  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([status, publishedAt])
  @@index([authorId])
}

model LoyaltyAction {
  id            String   @id @default(uuid())
  key           String   @unique
  name          String
  description   String?
  defaultPoints Int
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  transactions LoyaltyTransaction[]
}

model LoyaltyAccount {
  id               String   @id @default(uuid())
  userId           String   @unique
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  balance          Int      @default(0)
  lifetimeEarned   Int      @default(0)
  lifetimeRedeemed Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  transactions LoyaltyTransaction[]
  redemptions  LoyaltyRedemption[]
}

model LoyaltyTransaction {
  id            String         @id @default(uuid())
  accountId     String
  account       LoyaltyAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  actionId      String?
  action        LoyaltyAction? @relation(fields: [actionId], references: [id])
  userId        String
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  referenceType String?
  referenceId   String?
  points        Int
  description   String?
  metadata      Json?
  createdAt     DateTime       @default(now())

  @@index([accountId])
  @@index([actionId])
  @@index([userId])
  @@index([referenceType, referenceId])
}

model LoyaltyRedemption {
  id        String         @id @default(uuid())
  accountId String
  account   LoyaltyAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  userId    String
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  points    Int
  amount    Float
  note      String?
  createdAt DateTime       @default(now())

  @@index([accountId])
  @@index([userId])
}

enum PromoModalKind {
  promo
  info
  cookies
  alert
}

model PromoModal {
  id        String         @id @default(uuid())
  title     String?
  description String?
  imageUrl  String
  altText   String?
  targetUrl String?
  kind      PromoModalKind @default(promo)
  isActive  Boolean        @default(true)
  startsAt  DateTime?
  endsAt    DateTime?
  priority  Int            @default(0)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@index([isActive, startsAt, endsAt, priority])
}

model AnnouncementBar {
  id              String   @id @default(uuid())
  message         String
  targetUrl       String?
  backgroundColor String?
  textColor       String?
  isActive        Boolean  @default(true)
  startsAt        DateTime?
  endsAt          DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([isActive, startsAt, endsAt])
}

model CarouselSlide {
  id        String   @id @default(uuid())
  title     String?
  subtitle  String?
  imageUrl  String
  altText   String?
  targetUrl String?
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  startsAt  DateTime?
  endsAt    DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive, startsAt, endsAt])
  @@index([order])
}

model CompanyProfile {
  id            String   @id @default(uuid())
  name          String
  tagline       String?
  about         String?
  mission       String?
  vision        String?
  values        Json?
  email         String?
  phone         String?
  whatsapp      String?
  address       Json?
  mapUrl        String?
  logoUrl       String?
  supportHours  String?
  socialLinks   Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model LegalDocument {
  id          String            @id @default(uuid())
  type        LegalDocumentType
  title       String
  content     String
  version     String?
  isActive    Boolean           @default(true)
  publishedAt DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([type, isActive])
}

model UploadAsset {
  id        String          @id @default(uuid())
  ownerId   String?
  owner     User?           @relation(fields: [ownerId], references: [id], onDelete: SetNull)
  path      String          @unique
  folder    String
  filename  String
  url       String
  mimeType  String?
  type      UploadAssetType @default(image)
  size      Int             @default(0)
  isGlobal  Boolean         @default(false)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@index([ownerId, folder])
}
